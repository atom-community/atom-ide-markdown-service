"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.highlightTreeSitter = void 0;
const atom_1 = require("atom");
const event_loop_yielder_1 = require("./utils/event-loop-yielder");
async function highlightTreeSitter(sourceCode, scopeName) {
    const yielder = event_loop_yielder_1.eventLoopYielder(100, 5000);
    const buf = new atom_1.TextBuffer();
    try {
        const grammar = atom.grammars.grammarForId(scopeName);
        const lm = atom.grammars.languageModeForGrammarAndBuffer(grammar, buf);
        buf.setLanguageMode(lm);
        buf.setText(sourceCode);
        const end = buf.getEndPosition();
        if (lm.startTokenizing)
            lm.startTokenizing();
        await tokenized(lm);
        const iter = lm.buildHighlightIterator();
        if (iter.getOpenScopeIds && iter.getCloseScopeIds) {
            let pos = { row: 0, column: 0 };
            iter.seek(pos);
            const res = [];
            while (pos.row < end.row || (pos.row === end.row && pos.column <= end.column)) {
                res.push(...iter.getCloseScopeIds().map(() => "</span>"), ...iter.getOpenScopeIds().map((x) => `<span class="${lm.classNameForScopeId(x)}">`));
                iter.moveToSuccessor();
                const nextPos = iter.getPosition();
                res.push(escapeHTML(buf.getTextInRange([pos, nextPos])));
                if (!(await yielder())) {
                    console.error(event_loop_yielder_1.maxTimeError("Atom-IDE-Markdown-Service: Highlighter", 5));
                    break;
                }
                pos = nextPos;
            }
            return res.join("");
        }
        else {
            return sourceCode;
        }
    }
    finally {
        buf.destroy();
    }
}
exports.highlightTreeSitter = highlightTreeSitter;
async function tokenized(lm) {
    return new Promise((resolve) => {
        if (lm.fullyTokenized || lm.tree) {
            resolve(undefined);
        }
        else if (lm.onDidTokenize) {
            const disp = lm.onDidTokenize(() => {
                disp.dispose();
                resolve(undefined);
            });
        }
        else {
            resolve(undefined);
        }
    });
}
function escapeHTML(str) {
    return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlnaGxpZ2h0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaGlnaGxpZ2h0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0JBQStDO0FBQy9DLG1FQUEyRTtBQXlCcEUsS0FBSyxVQUFVLG1CQUFtQixDQUFDLFVBQWtCLEVBQUUsU0FBaUI7SUFDN0UsTUFBTSxPQUFPLEdBQUcscUNBQWdCLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFBO0lBQzNDLE1BQU0sR0FBRyxHQUFHLElBQUksaUJBQVUsRUFBRSxDQUFBO0lBQzVCLElBQUk7UUFDRixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQTtRQUNyRCxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLCtCQUErQixDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQTtRQUN0RSxHQUFHLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBQ3ZCLEdBQUcsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDdkIsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLGNBQWMsRUFBRSxDQUFBO1FBQ2hDLElBQUksRUFBRSxDQUFDLGVBQWU7WUFBRSxFQUFFLENBQUMsZUFBZSxFQUFFLENBQUE7UUFDNUMsTUFBTSxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUE7UUFDbkIsTUFBTSxJQUFJLEdBQUcsRUFBRSxDQUFDLHNCQUFzQixFQUFFLENBQUE7UUFDeEMsSUFBSSxJQUFJLENBQUMsZUFBZSxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtZQUNqRCxJQUFJLEdBQUcsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFBO1lBQy9CLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDZCxNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUE7WUFDZCxPQUFPLEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssR0FBRyxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRTtnQkFDN0UsR0FBRyxDQUFDLElBQUksQ0FDTixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxTQUFTLENBQUMsRUFDL0MsR0FBRyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FDcEYsQ0FBQTtnQkFDRCxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUE7Z0JBQ3RCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQTtnQkFDbEMsR0FBRyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFFeEQsSUFBSSxDQUFDLENBQUMsTUFBTSxPQUFPLEVBQUUsQ0FBQyxFQUFFO29CQUN0QixPQUFPLENBQUMsS0FBSyxDQUFDLGlDQUFZLENBQUMsd0NBQXdDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtvQkFDeEUsTUFBSztpQkFDTjtnQkFDRCxHQUFHLEdBQUcsT0FBTyxDQUFBO2FBQ2Q7WUFDRCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7U0FDcEI7YUFBTTtZQUNMLE9BQU8sVUFBVSxDQUFBO1NBQ2xCO0tBQ0Y7WUFBUztRQUNSLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQTtLQUNkO0FBQ0gsQ0FBQztBQXRDRCxrREFzQ0M7QUFFRCxLQUFLLFVBQVUsU0FBUyxDQUFDLEVBQWdCO0lBQ3ZDLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtRQUM3QixJQUFJLEVBQUUsQ0FBQyxjQUFjLElBQUksRUFBRSxDQUFDLElBQUksRUFBRTtZQUNoQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUE7U0FDbkI7YUFBTSxJQUFJLEVBQUUsQ0FBQyxhQUFhLEVBQUU7WUFDM0IsTUFBTSxJQUFJLEdBQUcsRUFBRSxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2pDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQTtnQkFDZCxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUE7WUFDcEIsQ0FBQyxDQUFDLENBQUE7U0FDSDthQUFNO1lBQ0wsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO1NBQ25CO0lBQ0gsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDO0FBRUQsU0FBUyxVQUFVLENBQUMsR0FBVztJQUM3QixPQUFPLEdBQUc7U0FDUCxPQUFPLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQztTQUN0QixPQUFPLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQztTQUNyQixPQUFPLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQztTQUNyQixPQUFPLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQztTQUN2QixPQUFPLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFBO0FBQzVCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXh0QnVmZmVyLCBMYW5ndWFnZU1vZGUgfSBmcm9tIFwiYXRvbVwiXHJcbmltcG9ydCB7IGV2ZW50TG9vcFlpZWxkZXIsIG1heFRpbWVFcnJvciB9IGZyb20gXCIuL3V0aWxzL2V2ZW50LWxvb3AteWllbGRlclwiXHJcblxyXG5kZWNsYXJlIG1vZHVsZSBcImF0b21cIiB7XHJcbiAgaW50ZXJmYWNlIEdyYW1tYXJSZWdpc3RyeSB7XHJcbiAgICBncmFtbWFyRm9ySWQoaWQ6IHN0cmluZyk6IEdyYW1tYXJcclxuICAgIGxhbmd1YWdlTW9kZUZvckdyYW1tYXJBbmRCdWZmZXIoZzogR3JhbW1hciwgYjogVGV4dEJ1ZmZlcik6IExhbmd1YWdlTW9kZVxyXG4gIH1cclxuICBpbnRlcmZhY2UgTGFuZ3VhZ2VNb2RlIHtcclxuICAgIHJlYWRvbmx5IGZ1bGx5VG9rZW5pemVkPzogYm9vbGVhblxyXG4gICAgcmVhZG9ubHkgdHJlZT86IGJvb2xlYW5cclxuICAgIG9uRGlkVG9rZW5pemUoY2I6ICgpID0+IHZvaWQpOiBEaXNwb3NhYmxlXHJcbiAgICBidWlsZEhpZ2hsaWdodEl0ZXJhdG9yKCk6IEhpZ2hsaWdodEl0ZXJhdG9yXHJcbiAgICBjbGFzc05hbWVGb3JTY29wZUlkKGlkOiBTY29wZUlkKTogc3RyaW5nXHJcbiAgICBzdGFydFRva2VuaXppbmc/KCk6IHZvaWRcclxuICB9XHJcbiAgaW50ZXJmYWNlIEhpZ2hsaWdodEl0ZXJhdG9yIHtcclxuICAgIHNlZWsocG9zOiB7IHJvdzogbnVtYmVyOyBjb2x1bW46IG51bWJlciB9KTogdm9pZFxyXG4gICAgZ2V0UG9zaXRpb24oKTogeyByb3c6IG51bWJlcjsgY29sdW1uOiBudW1iZXIgfVxyXG4gICAgZ2V0T3BlblNjb3BlSWRzPygpOiBTY29wZUlkW11cclxuICAgIGdldENsb3NlU2NvcGVJZHM/KCk6IFNjb3BlSWRbXVxyXG4gICAgbW92ZVRvU3VjY2Vzc29yKCk6IHZvaWRcclxuICB9XHJcbiAgaW50ZXJmYWNlIFNjb3BlSWQge31cclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGhpZ2hsaWdodFRyZWVTaXR0ZXIoc291cmNlQ29kZTogc3RyaW5nLCBzY29wZU5hbWU6IHN0cmluZykge1xyXG4gIGNvbnN0IHlpZWxkZXIgPSBldmVudExvb3BZaWVsZGVyKDEwMCwgNTAwMClcclxuICBjb25zdCBidWYgPSBuZXcgVGV4dEJ1ZmZlcigpXHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IGdyYW1tYXIgPSBhdG9tLmdyYW1tYXJzLmdyYW1tYXJGb3JJZChzY29wZU5hbWUpXHJcbiAgICBjb25zdCBsbSA9IGF0b20uZ3JhbW1hcnMubGFuZ3VhZ2VNb2RlRm9yR3JhbW1hckFuZEJ1ZmZlcihncmFtbWFyLCBidWYpXHJcbiAgICBidWYuc2V0TGFuZ3VhZ2VNb2RlKGxtKVxyXG4gICAgYnVmLnNldFRleHQoc291cmNlQ29kZSlcclxuICAgIGNvbnN0IGVuZCA9IGJ1Zi5nZXRFbmRQb3NpdGlvbigpXHJcbiAgICBpZiAobG0uc3RhcnRUb2tlbml6aW5nKSBsbS5zdGFydFRva2VuaXppbmcoKVxyXG4gICAgYXdhaXQgdG9rZW5pemVkKGxtKVxyXG4gICAgY29uc3QgaXRlciA9IGxtLmJ1aWxkSGlnaGxpZ2h0SXRlcmF0b3IoKVxyXG4gICAgaWYgKGl0ZXIuZ2V0T3BlblNjb3BlSWRzICYmIGl0ZXIuZ2V0Q2xvc2VTY29wZUlkcykge1xyXG4gICAgICBsZXQgcG9zID0geyByb3c6IDAsIGNvbHVtbjogMCB9XHJcbiAgICAgIGl0ZXIuc2Vlayhwb3MpXHJcbiAgICAgIGNvbnN0IHJlcyA9IFtdXHJcbiAgICAgIHdoaWxlIChwb3Mucm93IDwgZW5kLnJvdyB8fCAocG9zLnJvdyA9PT0gZW5kLnJvdyAmJiBwb3MuY29sdW1uIDw9IGVuZC5jb2x1bW4pKSB7XHJcbiAgICAgICAgcmVzLnB1c2goXHJcbiAgICAgICAgICAuLi5pdGVyLmdldENsb3NlU2NvcGVJZHMoKS5tYXAoKCkgPT4gXCI8L3NwYW4+XCIpLFxyXG4gICAgICAgICAgLi4uaXRlci5nZXRPcGVuU2NvcGVJZHMoKS5tYXAoKHgpID0+IGA8c3BhbiBjbGFzcz1cIiR7bG0uY2xhc3NOYW1lRm9yU2NvcGVJZCh4KX1cIj5gKVxyXG4gICAgICAgIClcclxuICAgICAgICBpdGVyLm1vdmVUb1N1Y2Nlc3NvcigpXHJcbiAgICAgICAgY29uc3QgbmV4dFBvcyA9IGl0ZXIuZ2V0UG9zaXRpb24oKVxyXG4gICAgICAgIHJlcy5wdXNoKGVzY2FwZUhUTUwoYnVmLmdldFRleHRJblJhbmdlKFtwb3MsIG5leHRQb3NdKSkpXHJcblxyXG4gICAgICAgIGlmICghKGF3YWl0IHlpZWxkZXIoKSkpIHtcclxuICAgICAgICAgIGNvbnNvbGUuZXJyb3IobWF4VGltZUVycm9yKFwiQXRvbS1JREUtTWFya2Rvd24tU2VydmljZTogSGlnaGxpZ2h0ZXJcIiwgNSkpXHJcbiAgICAgICAgICBicmVha1xyXG4gICAgICAgIH1cclxuICAgICAgICBwb3MgPSBuZXh0UG9zXHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHJlcy5qb2luKFwiXCIpXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gc291cmNlQ29kZVxyXG4gICAgfVxyXG4gIH0gZmluYWxseSB7XHJcbiAgICBidWYuZGVzdHJveSgpXHJcbiAgfVxyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiB0b2tlbml6ZWQobG06IExhbmd1YWdlTW9kZSkge1xyXG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xyXG4gICAgaWYgKGxtLmZ1bGx5VG9rZW5pemVkIHx8IGxtLnRyZWUpIHtcclxuICAgICAgcmVzb2x2ZSh1bmRlZmluZWQpXHJcbiAgICB9IGVsc2UgaWYgKGxtLm9uRGlkVG9rZW5pemUpIHtcclxuICAgICAgY29uc3QgZGlzcCA9IGxtLm9uRGlkVG9rZW5pemUoKCkgPT4ge1xyXG4gICAgICAgIGRpc3AuZGlzcG9zZSgpXHJcbiAgICAgICAgcmVzb2x2ZSh1bmRlZmluZWQpXHJcbiAgICAgIH0pXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXNvbHZlKHVuZGVmaW5lZCkgLy8gbnVsbCBsYW5ndWFnZSBtb2RlXHJcbiAgICB9XHJcbiAgfSlcclxufVxyXG5cclxuZnVuY3Rpb24gZXNjYXBlSFRNTChzdHI6IHN0cmluZykge1xyXG4gIHJldHVybiBzdHJcclxuICAgIC5yZXBsYWNlKC8mL2csIFwiJmFtcDtcIilcclxuICAgIC5yZXBsYWNlKC88L2csIFwiJmx0O1wiKVxyXG4gICAgLnJlcGxhY2UoLz4vZywgXCImZ3Q7XCIpXHJcbiAgICAucmVwbGFjZSgvXCIvZywgXCImcXVvdDtcIilcclxuICAgIC5yZXBsYWNlKC8nL2csIFwiJiMwMzk7XCIpXHJcbn1cclxuIl19